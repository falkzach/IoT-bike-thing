<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Bike Rides</title>
	<style>
		/* Always set the map height explicitly to define the size of the div
		* element that contains the map. */
		#map {
			height: 90%;
			margin: auto;
			width: 90%;
			border: 2px solid blue;
		}
		/* Optional: Makes the sample page fill the window. */
		html, body {
			height: 100%;
			margin: 0;
			padding: 0;
		}
		#floating-panel {
			position: absolute;
			top: 10px;
			left: 25%;
			z-index: 5;
			background-color: #fff;
			padding: 5px;
			border: 1px solid #999;
			text-align: center;
			font-family: 'Roboto','sans-serif';
			line-height: 30px;
			padding-left: 10px;
		}
		#floating-panel {
			background-color: #fff;
			border: 1px solid #999;
			left: 25%;
			padding: 5px;
			position: absolute;
			top: 10px;
			z-index: 5;
		}
	</style>
</head>

<body>
	<input type="file" id="files" name="files[]" multiple />

	<div id="floating-panel">
		<button onclick="toggleKmlLayer">Toggle KML</button>
		<button onclick="toggleHeatmap()">Toggle Heatmap</button>
		<button onclick="changeGradient()">Change gradient</button>
		<button onclick="changeRadius()">Change radius</button>
		<button onclick="changeOpacity()">Change opacity</button>
	</div>
	<div id="map"></div>
	<div id="lg"></div>
	<script>

		// This example requires the Visualization library. Include the libraries=visualization 

		var map, heatmap, kmlLayer, reader, parser, xmlDoc;

		var heatmapPoints = [];

		parser = new DOMParser();

		function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
				zoom: 13,
				center: {lat: 46.858574, lng: -114.012864},
				mapTypeId: 'satellite'
			});

			heatmap = new google.maps.visualization.HeatmapLayer({
				data: [],
				map: map
			});

			kmlLayer = new google.maps.KmlLayer({
				url: 'https://sites.google.com/site/kmlrepobikething/kml_files/sample_kml',
				suppressInfoWindows: true,
				map: map
			});

			kmlLayer.addListener('click', function(kmlEvent) {
				console.log(kmlEvent.featureData.info_window_html);
				var text = kmlEvent.featureData.info_window_html;
				showInContentWindow(text);
			});

			function showInContentWindow(text) {
				var sidediv = document.getElementById('lg');
				sidediv.innerHTML = text;
			}
		}

		function toggleHeatmap() {
			heatmap.setMap(heatmap.getMap() ? null : map);
		}

		function toggleKmlLayer() {
			kmlLayer.setMap(kmlLayer.getMap() ? map : null);
		}

		function changeGradient() {
			var gradient = [
				'rgba(0, 255, 255, 0)',
				'rgba(0, 255, 255, 1)',
				'rgba(0, 191, 255, 1)',
				'rgba(0, 127, 255, 1)',
				'rgba(0, 63, 255, 1)',
				'rgba(0, 0, 255, 1)',
				'rgba(0, 0, 223, 1)',
				'rgba(0, 0, 191, 1)',
				'rgba(0, 0, 159, 1)',
				'rgba(0, 0, 127, 1)',
				'rgba(63, 0, 91, 1)',
				'rgba(127, 0, 63, 1)',
				'rgba(191, 0, 31, 1)',
				'rgba(255, 0, 0, 1)'
			]
			heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
		}

		function changeRadius() {
			heatmap.set('radius', heatmap.get('radius') ? null : 25);
		}

		function changeOpacity() {
			heatmap.set('opacity', heatmap.get('opacity') ? null : 0.2);
		}

		function handleFileSelect(evt) {
			files = evt.target.files;

			// Loop through the FileList
			for (var i = 0, f; f = files[i]; i++) {

				var reader = new FileReader();

				// Closure to capture the file information.
				reader.onload = (function(theFile) {
					return function(e) {
						// Print the contents of the file
						var span = document.createElement('span');
						span.innerHTML = e.target.result;
						parseKML(span.innerHTML);
					};
				})(f);

				reader.readAsText(f);
			}
		}

		function parseKML(text) {
			xmlDoc = parser.parseFromString(text, "text/xml");
			var size = xmlDoc.getElementsByTagName("placemark").length;
			if (size > 0) {
				var coordinates = xmlDoc.getElementsByTagName("coordinates");
				if (xmlDoc.getElementsByTagName("extendeddata").length > 0) {
					var magnitudes = xmlDoc.getElementsByTagName("value");
					for (var p = 0; p < size; ++p) {
                
						var coor = coordinates[p].childNodes[0].nodeValue.split(',');
						var mag = xmlDoc.getElementsByTagName("value")[2*p+1].childNodes[0].nodeValue;
                
						heatmapPoints.push({location: new google.maps.LatLng(coor[1], coor[0]), weight: mag});
                
					}
                
				} else {
	
					console.log(coordinates[0].firstChild);
					coordinates = (coordinates[0].firstChild.nodeValue.replace( /\n/g, " " ).split( " " ));
					console.log(coordinates);
					for (var i = 0; i < coordinates.length; ++i) {
						coor = coordinates[i].split(',');
						if (coor.length > 1) {
								
							heatmapPoints.push(new google.maps.LatLng(coor[1], coor[0]));
						}
					}
				}
		
				console.log(heatmapPoints);
				heatmap.setData(heatmapPoints);
			}
		}
		
		document.getElementById('files').addEventListener('change', handleFileSelect, false);

	</script>
	<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKe8A9vDTluZYfwHZAsJmepp46QJr2gIc&libraries=visualization&callback=initMap">
	</script>
</body>
</html>
